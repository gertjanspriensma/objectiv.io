



    <div class="container-xl">
      <div class="row">

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <h1>Source code for buhtuh.merge</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Copyright 2021 Objectiv B.V.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Set</span><span class="p">,</span> <span class="n">NamedTuple</span>

<span class="kn">from</span> <span class="nn">buhtuh</span> <span class="kn">import</span> <span class="n">DataFrameOrSeries</span><span class="p">,</span> <span class="n">BuhTuhDataFrame</span><span class="p">,</span> <span class="n">ColumnNames</span><span class="p">,</span> <span class="n">BuhTuhSeries</span>
<span class="kn">from</span> <span class="nn">sql_models.model</span> <span class="kn">import</span> <span class="n">CustomSqlModel</span>


<div class="viewcode-block" id="How"><a class="viewcode-back" href="../../api/buhtuh.merge.html#buhtuh.merge.How">[docs]</a><span class="k">class</span> <span class="nc">How</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Enum with all valid values of &#39;how&#39; parameter &quot;&quot;&quot;</span>
    <span class="n">left</span> <span class="o">=</span> <span class="s1">&#39;left&#39;</span>
    <span class="n">right</span> <span class="o">=</span> <span class="s1">&#39;right&#39;</span>
    <span class="n">outer</span> <span class="o">=</span> <span class="s1">&#39;outer&#39;</span>
    <span class="n">inner</span> <span class="o">=</span> <span class="s1">&#39;inner&#39;</span>
    <span class="n">cross</span> <span class="o">=</span> <span class="s1">&#39;cross&#39;</span></div>


<span class="k">def</span> <span class="nf">_determine_left_on_right_on</span><span class="p">(</span>
        <span class="n">left</span><span class="p">:</span> <span class="n">BuhTuhDataFrame</span><span class="p">,</span>
        <span class="n">right</span><span class="p">:</span> <span class="n">DataFrameOrSeries</span><span class="p">,</span>
        <span class="n">how</span><span class="p">:</span> <span class="n">How</span><span class="p">,</span>
        <span class="n">on</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ColumnNames</span><span class="p">],</span>
        <span class="n">left_on</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ColumnNames</span><span class="p">],</span>
        <span class="n">right_on</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ColumnNames</span><span class="p">],</span>
        <span class="n">left_index</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">right_index</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine the columns that should be equal for the merge. Both for the left and the right</span>
<span class="sd">    dataframse/series a list of strings is returned indicating the names of the columns that should be</span>
<span class="sd">    matched.</span>
<span class="sd">    :return: tuple with left_on and right_on</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">how</span> <span class="o">==</span> <span class="n">How</span><span class="o">.</span><span class="n">cross</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">on</span> <span class="ow">or</span> <span class="n">left_on</span> <span class="ow">or</span> <span class="n">right_on</span> <span class="ow">or</span> <span class="n">left_index</span> <span class="ow">or</span> <span class="n">right_index</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot specify on, left_on, right_on, left_index, or right_index&#39;</span>
                             <span class="s1">&#39;if how == &quot;cross&quot;&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[],</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">left_on</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">left_index</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot specify both left_on and left_index.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">right_on</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">right_index</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot specify both right_on and right_index.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">left_index</span><span class="p">:</span>
        <span class="n">left_on</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">_get_index_names</span><span class="p">(</span><span class="n">left</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">right_index</span><span class="p">:</span>
        <span class="n">right_on</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">_get_index_names</span><span class="p">(</span><span class="n">right</span><span class="p">))</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">left_on</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="p">(</span><span class="n">right_on</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Either both left_on and right_on should be specified, or both should be None.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">on</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">left_on</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">right_on</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Either specify on or, left_on and right_on, but not all three&#39;</span><span class="p">)</span>

    <span class="n">left_cols</span> <span class="o">=</span> <span class="n">_get_data_columns</span><span class="p">(</span><span class="n">left</span><span class="p">)</span>
    <span class="n">right_cols</span> <span class="o">=</span> <span class="n">_get_data_columns</span><span class="p">(</span><span class="n">right</span><span class="p">)</span>
    <span class="n">intersection_columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">left_cols</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">right_cols</span><span class="p">))</span>
    <span class="n">final_on</span> <span class="o">=</span> <span class="n">on</span> <span class="k">if</span> <span class="n">on</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">intersection_columns</span>
    <span class="n">final_left_on</span> <span class="o">=</span> <span class="n">_get_x_on</span><span class="p">(</span><span class="n">final_on</span><span class="p">,</span> <span class="n">left_on</span><span class="p">,</span> <span class="s1">&#39;left_on&#39;</span><span class="p">)</span>
    <span class="n">final_right_on</span> <span class="o">=</span> <span class="n">_get_x_on</span><span class="p">(</span><span class="n">final_on</span><span class="p">,</span> <span class="n">right_on</span><span class="p">,</span> <span class="s1">&#39;right_on&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">final_left_on</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">final_right_on</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;Len of left_on (</span><span class="si">{</span><span class="n">final_left_on</span><span class="si">}</span><span class="s1">) does not match that of right_on (</span><span class="si">{</span><span class="n">final_right_on</span><span class="si">}</span><span class="s1">).&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">final_left_on</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No columns to perform merge on&#39;</span><span class="p">)</span>
    <span class="n">missing_left</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">final_left_on</span><span class="p">)</span> <span class="o">-</span> <span class="n">_get_all_series_names</span><span class="p">(</span><span class="n">left</span><span class="p">)</span>
    <span class="n">missing_right</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">final_right_on</span><span class="p">)</span> <span class="o">-</span> <span class="n">_get_all_series_names</span><span class="p">(</span><span class="n">right</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">missing_left</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Specified column(s) do not exist. left_on: </span><span class="si">{</span><span class="n">left_on</span><span class="si">}</span><span class="s1">. missing: </span><span class="si">{</span><span class="n">missing_left</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">missing_right</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Specified column(s) do not exist. right_on: </span><span class="si">{</span><span class="n">right_on</span><span class="si">}</span><span class="s1">. missing: </span><span class="si">{</span><span class="n">missing_right</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">final_left_on</span><span class="p">,</span> <span class="n">final_right_on</span>


<span class="k">def</span> <span class="nf">_get_data_columns</span><span class="p">(</span><span class="n">df_series</span><span class="p">:</span> <span class="n">DataFrameOrSeries</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot; Get set with the names of all data columns. Works for both dataframe and series. &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df_series</span><span class="p">,</span> <span class="n">BuhTuhDataFrame</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="n">df_series</span><span class="o">.</span><span class="n">data_columns</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df_series</span><span class="p">,</span> <span class="n">BuhTuhSeries</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">df_series</span><span class="o">.</span><span class="n">name</span><span class="p">}</span>
    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Expected BuhTuhDataFrame or BuhTuhSeries, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">df_series</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_get_index_names</span><span class="p">(</span><span class="n">df_series</span><span class="p">:</span> <span class="n">DataFrameOrSeries</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot; Get set the names of the index columns. Works for both dataframe and series. &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">df_series</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="n">df_series</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">_get_all_series_names</span><span class="p">(</span><span class="n">df_series</span><span class="p">:</span> <span class="n">DataFrameOrSeries</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot; Get set with the names of all series. Works for both dataframe and series. &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_get_index_names</span><span class="p">(</span><span class="n">df_series</span><span class="p">)</span> <span class="o">|</span> <span class="n">_get_data_columns</span><span class="p">(</span><span class="n">df_series</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_get_x_on</span><span class="p">(</span><span class="n">on</span><span class="p">:</span> <span class="n">ColumnNames</span><span class="p">,</span> <span class="n">x_on</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ColumnNames</span><span class="p">],</span> <span class="n">var_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot; Helper for _determine_left_on_right_on: Give `x_on` as a List[str], or default to `on`. &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x_on</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">x_on</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x_on</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x_on</span>
    <span class="k">if</span> <span class="n">x_on</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">on</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">on</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">on</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">on</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Type of on is not supported. Type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">on</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Type of </span><span class="si">{</span><span class="n">var_name</span><span class="si">}</span><span class="s1"> is not supported. Type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">x_on</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="ResultColumn"><a class="viewcode-back" href="../../api/buhtuh.merge.html#buhtuh.merge.ResultColumn">[docs]</a><span class="k">class</span> <span class="nc">ResultColumn</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">expression</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">dtype</span><span class="p">:</span> <span class="nb">str</span></div>


<span class="k">def</span> <span class="nf">_determine_result_columns</span><span class="p">(</span>
        <span class="n">left</span><span class="p">:</span> <span class="n">BuhTuhDataFrame</span><span class="p">,</span>
        <span class="n">right</span><span class="p">:</span> <span class="n">DataFrameOrSeries</span><span class="p">,</span>
        <span class="n">left_on</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">right_on</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">suffixes</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">ResultColumn</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">ResultColumn</span><span class="p">]]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine which columns should be in the DataFrame after merging left and right, with the given</span>
<span class="sd">    left_on and right_on values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">filter_columns_from_right</span> <span class="o">=</span> <span class="n">_get_filter_columns_from_right</span><span class="p">(</span><span class="n">left_on</span><span class="p">,</span> <span class="n">right_on</span><span class="p">)</span>
    <span class="n">left_index</span> <span class="o">=</span> <span class="n">left</span><span class="o">.</span><span class="n">index</span>
    <span class="k">if</span> <span class="n">right</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="n">right_index</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">label</span><span class="p">:</span> <span class="n">series</span> <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">series</span> <span class="ow">in</span> <span class="n">right</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">filter_columns_from_right</span>
        <span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">right_index</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">left_data</span> <span class="o">=</span> <span class="n">left</span><span class="o">.</span><span class="n">data</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">right</span><span class="p">,</span> <span class="n">BuhTuhDataFrame</span><span class="p">):</span>
        <span class="n">right_data</span> <span class="o">=</span> <span class="n">right</span><span class="o">.</span><span class="n">data</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">right</span><span class="p">,</span> <span class="n">BuhTuhSeries</span><span class="p">):</span>
        <span class="n">right_data</span> <span class="o">=</span> <span class="p">{</span><span class="n">right</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">right</span><span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Right should be DataFrameOrSeries type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">right</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">right_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">label</span><span class="p">:</span> <span class="n">series</span> <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">series</span> <span class="ow">in</span> <span class="n">right_data</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">filter_columns_from_right</span>
    <span class="p">}</span>

    <span class="n">conflicting</span> <span class="o">=</span> <span class="nb">set</span><span class="p">({</span><span class="o">**</span><span class="n">left_index</span><span class="p">,</span> <span class="o">**</span><span class="n">left_data</span><span class="p">}</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">({</span><span class="o">**</span><span class="n">right_index</span><span class="p">,</span> <span class="o">**</span><span class="n">right_data</span><span class="p">}))</span>
    <span class="n">new_index_list</span> <span class="o">=</span> <span class="n">_get_column_name_expr_dtype</span><span class="p">(</span><span class="n">left_index</span><span class="p">,</span> <span class="n">conflicting</span><span class="p">,</span> <span class="n">suffixes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;l&#39;</span><span class="p">)</span>
    <span class="n">new_index_list</span> <span class="o">+=</span> <span class="n">_get_column_name_expr_dtype</span><span class="p">(</span><span class="n">right_index</span><span class="p">,</span> <span class="n">conflicting</span><span class="p">,</span> <span class="n">suffixes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">new_data_list</span> <span class="o">=</span> <span class="n">_get_column_name_expr_dtype</span><span class="p">(</span><span class="n">left_data</span><span class="p">,</span> <span class="n">conflicting</span><span class="p">,</span> <span class="n">suffixes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;l&#39;</span><span class="p">)</span>
    <span class="n">new_data_list</span> <span class="o">+=</span> <span class="n">_get_column_name_expr_dtype</span><span class="p">(</span><span class="n">right_data</span><span class="p">,</span> <span class="n">conflicting</span><span class="p">,</span> <span class="n">suffixes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">_check_no_column_name_conflicts</span><span class="p">(</span><span class="n">new_index_list</span> <span class="o">+</span> <span class="n">new_data_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new_index_list</span><span class="p">,</span> <span class="n">new_data_list</span>


<span class="k">def</span> <span class="nf">_check_no_column_name_conflicts</span><span class="p">(</span><span class="n">result_columns</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ResultColumn</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot; Helper of _determine_result_columns, checks that there are no duplicate names in the list.  &quot;&quot;&quot;</span>
    <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">rc</span> <span class="ow">in</span> <span class="n">result_columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">rc</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Names are not unique. Result contains </span><span class="si">{</span><span class="n">rc</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> multiple times&#39;</span><span class="p">)</span>
        <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">rc</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_get_filter_columns_from_right</span><span class="p">(</span><span class="n">left_on</span><span class="p">,</span> <span class="n">right_on</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper of _determine_result_columns: get all columns that should not be included from the right df,</span>
<span class="sd">    as they are matched on the same column on the left.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">left_on_pos</span> <span class="o">=</span> <span class="p">{</span><span class="n">label</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">left_on</span><span class="p">)}</span>
    <span class="n">right_on_pos</span> <span class="o">=</span> <span class="p">{</span><span class="n">label</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">right_on</span><span class="p">)}</span>
    <span class="c1"># don&#39;t add a column from the right to the result if we are joining on that column and the column in</span>
    <span class="c1"># left has the same name</span>
    <span class="n">filter_column_from_right</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">label</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">right_on_pos</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">right_on_pos</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">==</span> <span class="n">left_on_pos</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">filter_column_from_right</span>


<span class="k">def</span> <span class="nf">_get_column_name_expr_dtype</span><span class="p">(</span>
        <span class="n">source_series</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">BuhTuhSeries</span><span class="p">],</span>
        <span class="n">conflicting_names</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">suffix</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">table_alias</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ResultColumn</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot; Helper of _determine_result_columns. &quot;&quot;&quot;</span>
    <span class="n">new_index_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ResultColumn</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">index_name</span><span class="p">,</span> <span class="n">series</span> <span class="ow">in</span> <span class="n">source_series</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">new_name</span> <span class="o">=</span> <span class="n">index_name</span>
        <span class="k">if</span> <span class="n">index_name</span> <span class="ow">in</span> <span class="n">conflicting_names</span><span class="p">:</span>
            <span class="n">new_name</span> <span class="o">=</span> <span class="n">index_name</span> <span class="o">+</span> <span class="n">suffix</span>
        <span class="n">new_index_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ResultColumn</span><span class="p">(</span><span class="n">new_name</span><span class="p">,</span> <span class="n">series</span><span class="o">.</span><span class="n">get_expression</span><span class="p">(</span><span class="n">table_alias</span><span class="p">),</span> <span class="n">series</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">new_index_list</span>


<div class="viewcode-block" id="merge"><a class="viewcode-back" href="../../api/buhtuh.merge.html#buhtuh.merge.merge">[docs]</a><span class="k">def</span> <span class="nf">merge</span><span class="p">(</span>
        <span class="n">left</span><span class="p">:</span> <span class="n">BuhTuhDataFrame</span><span class="p">,</span>
        <span class="n">right</span><span class="p">:</span> <span class="n">DataFrameOrSeries</span><span class="p">,</span>
        <span class="n">how</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">on</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">],</span>
        <span class="n">left_on</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>  <span class="kc">None</span><span class="p">],</span>  <span class="c1"># todo: also support array-like arguments?</span>
        <span class="n">right_on</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">],</span>
        <span class="n">left_index</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">right_index</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">suffixes</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BuhTuhDataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Join the left and right Dataframes, or a DataFrame (left) and a Series (right). This will return a new</span>
<span class="sd">    DataFrame that contains the combined columns of both dataframes, and the rows that result from joining</span>
<span class="sd">    on the specified columns. The columns that are joined on can consists (partially or fully) out of index</span>
<span class="sd">    columns.</span>

<span class="sd">    If the column names on the left and right conflict, then the suffixes are used to distinguish them in the</span>
<span class="sd">    resulting DataFrame. The algorithm for determining the resulting columns and their names is similar to</span>
<span class="sd">    Pandas, but has slight differences when joining on indices and column names conflict.</span>

<span class="sd">    :param left: left DataFrame</span>
<span class="sd">    :param right: DataFrame or Series to join on left</span>
<span class="sd">    :param how: supported values: {‘left’, ‘right’, ‘outer’, ‘inner’, ‘cross’}</span>
<span class="sd">    :param on: optional, column(s) to join left and right on.</span>
<span class="sd">    :param left_on: optional, column(s) from the left df to join on</span>
<span class="sd">    :param right_on: optional, column(s) from the right df/series to join on</span>
<span class="sd">    :param left_index: If true uses the index of the left df as columns to join on</span>
<span class="sd">    :param right_index: If true uses the index of the right df/series as columns to join on</span>
<span class="sd">    :param suffixes: Tuple of two strings. Will be used to suffix duplicate column names. Must make column</span>
<span class="sd">        names unique</span>
<span class="sd">    :return: A new Dataframe. The original frames are not modified.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">how</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="s1">&#39;outer&#39;</span><span class="p">,</span> <span class="s1">&#39;inner&#39;</span><span class="p">,</span> <span class="s1">&#39;cross&#39;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;how must be one of (&#39;left&#39;, &#39;right&#39;, &#39;outer&#39;, &#39;inner&#39;, &#39;cross&#39;), value: </span><span class="si">{</span><span class="n">how</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">real_how</span> <span class="o">=</span> <span class="n">How</span><span class="p">(</span><span class="n">how</span><span class="p">)</span>
    <span class="n">real_left_on</span><span class="p">,</span> <span class="n">real_right_on</span> <span class="o">=</span> <span class="n">_determine_left_on_right_on</span><span class="p">(</span>
        <span class="n">left</span><span class="o">=</span><span class="n">left</span><span class="p">,</span>
        <span class="n">right</span><span class="o">=</span><span class="n">right</span><span class="p">,</span>
        <span class="n">how</span><span class="o">=</span><span class="n">real_how</span><span class="p">,</span>
        <span class="n">on</span><span class="o">=</span><span class="n">on</span><span class="p">,</span>
        <span class="n">left_on</span><span class="o">=</span><span class="n">left_on</span><span class="p">,</span>
        <span class="n">right_on</span><span class="o">=</span><span class="n">right_on</span><span class="p">,</span>
        <span class="n">left_index</span><span class="o">=</span><span class="n">left_index</span><span class="p">,</span>
        <span class="n">right_index</span><span class="o">=</span><span class="n">right_index</span>
    <span class="p">)</span>
    <span class="n">new_index_list</span><span class="p">,</span> <span class="n">new_data_list</span> <span class="o">=</span> <span class="n">_determine_result_columns</span><span class="p">(</span>
        <span class="n">left</span><span class="o">=</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="n">right</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="n">real_left_on</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="n">real_right_on</span><span class="p">,</span> <span class="n">suffixes</span><span class="o">=</span><span class="n">suffixes</span>
    <span class="p">)</span>

    <span class="n">sql</span> <span class="o">=</span> <span class="n">_get_merge_sql</span><span class="p">(</span>
        <span class="n">left</span><span class="o">=</span><span class="n">left</span><span class="p">,</span>
        <span class="n">right</span><span class="o">=</span><span class="n">right</span><span class="p">,</span>
        <span class="n">how</span><span class="o">=</span><span class="n">real_how</span><span class="p">,</span>
        <span class="n">real_left_on</span><span class="o">=</span><span class="n">real_left_on</span><span class="p">,</span>
        <span class="n">real_right_on</span><span class="o">=</span><span class="n">real_right_on</span><span class="p">,</span>
        <span class="n">new_column_list</span><span class="o">=</span><span class="n">new_index_list</span> <span class="o">+</span> <span class="n">new_data_list</span>
    <span class="p">)</span>
    <span class="n">model_builder</span> <span class="o">=</span> <span class="n">CustomSqlModel</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;merge_sql&#39;</span><span class="p">,</span> <span class="n">sql</span><span class="o">=</span><span class="n">sql</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">model_builder</span><span class="p">(</span><span class="n">left_node</span><span class="o">=</span><span class="n">left</span><span class="o">.</span><span class="n">base_node</span><span class="p">,</span> <span class="n">right_node</span><span class="o">=</span><span class="n">right</span><span class="o">.</span><span class="n">base_node</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">BuhTuhDataFrame</span><span class="o">.</span><span class="n">get_instance</span><span class="p">(</span>
        <span class="n">engine</span><span class="o">=</span><span class="n">left</span><span class="o">.</span><span class="n">engine</span><span class="p">,</span>
        <span class="n">source_node</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
        <span class="n">index_dtypes</span><span class="o">=</span><span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">dtype</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">_expr</span><span class="p">,</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="n">new_index_list</span><span class="p">},</span>
        <span class="n">dtypes</span><span class="o">=</span><span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">dtype</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">_expr</span><span class="p">,</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="n">new_data_list</span><span class="p">}</span>
    <span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_get_merge_sql</span><span class="p">(</span>
        <span class="n">left</span><span class="p">:</span> <span class="n">BuhTuhDataFrame</span><span class="p">,</span>
        <span class="n">right</span><span class="p">:</span> <span class="n">DataFrameOrSeries</span><span class="p">,</span>
        <span class="n">how</span><span class="p">:</span> <span class="n">How</span><span class="p">,</span>
        <span class="n">real_left_on</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">real_right_on</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">new_column_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ResultColumn</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Give the sql to join left and right and select the new_column_list.</span>
<span class="sd">    Left and right will be joined with the join type of how, matching rows on real_left_on and real_right_on.</span>

<span class="sd">    The returned sql will have two place holders: &#39;{{left_node}}&#39; and &#39;{{right_node}}&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># todo: sql escaping where needed</span>
    <span class="n">merge_conditions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">l_label</span><span class="p">,</span> <span class="n">r_label</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">real_left_on</span><span class="p">,</span> <span class="n">real_right_on</span><span class="p">):</span>
        <span class="n">l_expr</span> <span class="o">=</span> <span class="n">_get_expression</span><span class="p">(</span><span class="n">df_series</span><span class="o">=</span><span class="n">left</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">l_label</span><span class="p">,</span> <span class="n">table_alias</span><span class="o">=</span><span class="s1">&#39;l&#39;</span><span class="p">)</span>
        <span class="n">r_expr</span> <span class="o">=</span> <span class="n">_get_expression</span><span class="p">(</span><span class="n">df_series</span><span class="o">=</span><span class="n">right</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">r_label</span><span class="p">,</span> <span class="n">table_alias</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">merge_conditions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="n">l_expr</span><span class="si">}</span><span class="s1"> = </span><span class="si">{</span><span class="n">r_expr</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>

    <span class="n">columns_str</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">expr</span><span class="si">}</span><span class="s1"> as &quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&quot;&#39;</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">_dtype</span> <span class="ow">in</span> <span class="n">new_column_list</span><span class="p">)</span>
    <span class="n">join_type</span> <span class="o">=</span> <span class="s1">&#39;full outer&#39;</span> <span class="k">if</span> <span class="n">how</span> <span class="o">==</span> <span class="n">How</span><span class="o">.</span><span class="n">outer</span> <span class="k">else</span> <span class="n">how</span><span class="o">.</span><span class="n">value</span>
    <span class="n">on_str</span> <span class="o">=</span> <span class="s1">&#39;on &#39;</span> <span class="o">+</span> <span class="s1">&#39; and &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">merge_conditions</span><span class="p">)</span> <span class="k">if</span> <span class="n">merge_conditions</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>

    <span class="n">sql</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">        select </span><span class="si">{</span><span class="n">columns_str</span><span class="si">}</span><span class="s1"></span>
<span class="s1">        from </span><span class="se">{{{{</span><span class="s1">left_node</span><span class="se">}}}}</span><span class="s1"> as l </span><span class="si">{</span><span class="n">join_type</span><span class="si">}</span><span class="s1"></span>
<span class="s1">        join </span><span class="se">{{{{</span><span class="s1">right_node</span><span class="se">}}}}</span><span class="s1"> as r </span><span class="si">{</span><span class="n">on_str</span><span class="si">}</span><span class="s1"></span>
<span class="s1">        &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">sql</span>


<span class="k">def</span> <span class="nf">_get_expression</span><span class="p">(</span><span class="n">df_series</span><span class="p">:</span> <span class="n">DataFrameOrSeries</span><span class="p">,</span> <span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">table_alias</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot; Helper of merge: give the expression for the column with the given label in df_series as a string &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">df_series</span><span class="o">.</span><span class="n">index</span> <span class="ow">and</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">df_series</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df_series</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">get_expression</span><span class="p">(</span><span class="n">table_alias</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df_series</span><span class="p">,</span> <span class="n">BuhTuhDataFrame</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">df_series</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">get_expression</span><span class="p">(</span><span class="n">table_alias</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df_series</span><span class="p">,</span> <span class="n">BuhTuhSeries</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">df_series</span><span class="o">.</span><span class="n">get_expression</span><span class="p">(</span><span class="n">table_alias</span><span class="p">)</span>
    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;df_series should be DataFrameOrSeries. type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">df_series</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>

              </div>
              
          

      </div>
    </div>
